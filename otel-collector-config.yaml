receivers:
  # OTLP receiver for traces (if needed for other sources)
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  # Prometheus receiver (scrape metrics)
  prometheus:
    config:
      scrape_configs:
        - job_name: 'otel-collector'
          scrape_interval: 30s
          static_configs:
            - targets: ['localhost:8888']
        
        - job_name: 'xiaozhou-order'
          scrape_interval: 30s
          static_configs:
            - targets: ['xiaozhou-order:8089']
          metrics_path: '/actuator/prometheus'
        
        - job_name: 'xiaozhou-product'
          scrape_interval: 30s
          static_configs:
            - targets: ['xiaozhou-product:8090']
          metrics_path: '/actuator/prometheus'
        
        - job_name: 'cadvisor'
          scrape_interval: 30s
          static_configs:
            - targets: ['cadvisor:8080']
# 对数据进行预处理和增强。
# 将数据分批发送，提高效率。每批最多 1024 条，或等待 10 秒后发送。
processors:
  batch:
    timeout: 10s
    send_batch_size: 1024
  
  resource:
    attributes:
      - key: deployment.environment
        value: "production"
        action: insert
  
  resourcedetection:
    detectors: [env, system]
    timeout: 5s

exporters:
  # OTLP exporter to Data Prepper (for metrics)
  otlp/dataprepper-metrics:
    endpoint: data-prepper:21891
    tls:
      insecure: true
  
  # OTLP exporter to Data Prepper (for traces)
  otlp/dataprepper-traces:
    endpoint: data-prepper:21890
    tls:
      insecure: true
# 定义了两个数据处理管道，分别负责指标和追踪（日志已通过grpc-log直接发送到SkyWalking OAP，指标已同步到OpenSearch）
service:
  pipelines:
    metrics:
      receivers: [prometheus]
      processors: [batch, resource]
      exporters: [otlp/dataprepper-metrics]
    
    # Traces pipeline - receives OTLP traces from OTLP receiver
    traces:
      receivers: [otlp]
      processors: [batch, resource]
      exporters: [otlp/dataprepper-traces]
  
  telemetry:
    logs:
      level: info
