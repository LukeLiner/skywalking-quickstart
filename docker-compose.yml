

services:
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: nacos-standalone
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=hostname
      - JVM_XMS=256m
      - JVM_XMX=256m
      - JVM_XMN=128m
    volumes:
      - nacos-logs:/home/nacos/logs
      - nacos-data:/home/nacos/data
    ports:
      - "8848:8848"
      - "9848:9848" # gRPC port for Nacos 2.x
    networks:
      - skywalking-net

  # SkyWalking OAP - NOT receiving agent traces in Full OTel mode
  # Agents report to OTel Collector instead
  skywalking-oap:
    build:
      context: .
      dockerfile: skywalking-oap/Dockerfile
    container_name: skywalking-oap
    ports:
      - "11800:11800"  # gRPC port for agents
      - "12800:12800"  # HTTP port for UI
    environment:
      - SW_STORAGE=elasticsearch
      - SW_STORAGE_ES_CLUSTER_NODES=opensearch:9200
      # When DISABLE_SECURITY_PLUGIN=true, no auth required
      # - SW_STORAGE_ES_USER=admin
      # - SW_STORAGE_ES_PASSWORD=admin
      - SW_STORAGE_ES_INDEX_REPLICAS=0
      - SW_STORAGE_ES_INDEX_SHARDS=2
      # Kafka Fetcher Configuration - consume from Kafka
      - SW_KAFKA_FETCHER=default
      - SW_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SW_KAFKA_FETCHER_GROUP_ID=skywalking-oap
      - SW_KAFKA_FETCHER_TOPIC_TRACING=sw-traces
      - SW_KAFKA_FETCHER_TOPIC_METRICS=sw-metrics
      - SW_KAFKA_FETCHER_ENABLE_NATIVE_PROTO_LOG=true
      # Kafka Producer Config (for admin client)
      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/12800"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - skywalking-net
    depends_on:
      opensearch:
        condition: service_started
      kafka:
        condition: service_healthy

  skywalking-ui:
    image: apache/skywalking-ui:9.4.0
    container_name: skywalking-ui
    depends_on:
      skywalking-oap:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - SW_OAP_ADDRESS=http://skywalking-oap:12800
    networks:
      - skywalking-net

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=mytestshop
    ports:
      - "3306:3306"
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - skywalking-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ============== Kafka Infrastructure ==============
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - skywalking-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      skywalking-net:
        ipv4_address: 172.20.0.10

  xiaozhou-order:
    build:
      context: .
      dockerfile: xiaozhou-order/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-order
    ports:
      - "8089:8089"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SW_AGENT_NAME=xiaozhou-order
      # Enable trace sampling (1 sample per 3 seconds)
      - SW_AGENT_SAMPLE=1
      # Enable Kafka reporter to send data to Kafka
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=kafka:9092
      - SW_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # Configure Kafka topic to match OAP Kafka Fetcher
      - SW_PLUGIN_KAFKA_TOPIC_SEGMENT=sw-traces
      - SW_PLUGIN_KAFKA_TOPIC_METRICS=sw-metrics
      - JAVA_OPTS=-DSW_AGENT_COLLECTOR_BACKEND_SERVICES=kafka:9092
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      nacos:
        condition: service_started
      kafka:
        condition: service_healthy
    networks:
      - skywalking-net

  xiaozhou-product:
    build:
      context: .
      dockerfile: xiaozhou-product/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-product
    ports:
      - "8090:8090"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/mytestshop?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2b8&allowMultiQueries=true&allowPublicKeyRetrieval=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SW_AGENT_NAME=xiaozhou-product
      # Enable trace sampling (1 sample per 3 seconds)
      - SW_AGENT_SAMPLE=1
      # Enable Kafka reporter to send data to Kafka
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=kafka:9092
      - SW_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      # Configure Kafka topic to match OAP Kafka Fetcher
      - SW_PLUGIN_KAFKA_TOPIC_SEGMENT=sw-traces
      - SW_PLUGIN_KAFKA_TOPIC_METRICS=sw-metrics
      - JAVA_OPTS=-DSW_AGENT_COLLECTOR_BACKEND_SERVICES=kafka:9092
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_started
      kafka:
        condition: service_healthy
    networks:
      - skywalking-net

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - skywalking-net

  # OpenSearch for log/metrics/traces storage (official recommended version 2.8.0)
  opensearch:
    image: opensearchproject/opensearch:2.8.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - skywalking-net

  # OpenSearch Dashboards for visualization
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.8.0
    container_name: opensearch-dashboards
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
      - SERVER_DEFAULTROUTE=/app/home
      - OPENSEARCH_DASHBOARDS_DEFAULTAPPID=home
    networks:
      - skywalking-net
    depends_on:
      - opensearch

  # OpenTelemetry Collector for logs, metrics, and traces
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
      # - "11800:11800"  # SkyWalking gRPC receiver (agents report here)
      # - "12800:12800"  # SkyWalking HTTP receiver
      - "8889:8889"    # Prometheus metrics endpoint
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
      - app-logs:/var/log/apps:ro
    networks:
      - skywalking-net
    depends_on:
      - opensearch
      - data-prepper
      - xiaozhou-order
      - xiaozhou-product

  # Data Prepper for metrics and traces ingestion to OpenSearch
  data-prepper:
    image: opensearchproject/data-prepper:2.6.1
    container_name: data-prepper
    volumes:
      - ./data-prepper/pipelines.yaml:/usr/share/data-prepper/pipelines/pipelines.yaml
      - ./data-prepper/data-prepper-config.yaml:/usr/share/data-prepper/config/data-prepper-config.yaml
    ports:
      - "21890:21890"  # OTel trace source
      - "21891:21891"  # OTel metrics source
    networks:
      - skywalking-net
    depends_on:
      opensearch:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: always

networks:
  skywalking-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  opensearch-data:
  app-logs:
  nacos-logs:
  nacos-data:
