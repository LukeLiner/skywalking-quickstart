

services:
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: nacos-standalone
    environment:
      - MODE=standalone
    ports:
      - "8848:8848"
      - "9848:9848" # gRPC port for Nacos 2.x
    networks:
      - skywalking-net

  skywalking-oap:
    build:
      context: .
      dockerfile: skywalking-oap/Dockerfile
    container_name: skywalking-oap
    ports:
      - "11800:11800"
      - "12800:12800"
    environment:
      - SW_STORAGE=mysql
      - SW_JDBC_URL=jdbc:mysql://mysql:3306/skywalking?useSSL=false&serverTimezone=GMT&allowPublicKeyRetrieval=true
      - SW_DATA_SOURCE_USER=root
      - SW_DATA_SOURCE_PASSWORD=root
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/12800"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - skywalking-net
    depends_on:
      mysql:
        condition: service_healthy

  skywalking-ui:
    image: apache/skywalking-ui:9.3.0
    container_name: skywalking-ui
    depends_on:
      skywalking-oap:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - SW_OAP_ADDRESS=http://skywalking-oap:12800
    networks:
      - skywalking-net

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=mytestshop
    ports:
      - "3306:3306"
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - skywalking-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  xiaozhou-order:
    build:
      context: .
      dockerfile: xiaozhou-order/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-order
    ports:
      - "8089:8089"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SW_AGENT_NAME=xiaozhou-order
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=skywalking-oap:11800
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      - nacos
      - skywalking-oap
    networks:
      - skywalking-net

  xiaozhou-product:
    build:
      context: .
      dockerfile: xiaozhou-product/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-product
    ports:
      - "8090:8090"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/mytestshop?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2b8&allowMultiQueries=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SW_AGENT_NAME=xiaozhou-product
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=skywalking-oap:11800
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_started
      skywalking-oap:
        condition: service_started
    networks:
      - skywalking-net

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - skywalking-net
    depends_on:
      - xiaozhou-order
      - xiaozhou-product

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - skywalking-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - skywalking-net
    depends_on:
      - prometheus

  # OpenSearch for log storage
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - skywalking-net

  # OpenSearch Dashboards for visualization
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.0
    container_name: opensearch-dashboards
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
      - SERVER_DEFAULTROUTE=/app/home
      - OPENSEARCH_DASHBOARDS_DEFAULTAPPID=home
    networks:
      - skywalking-net
    depends_on:
      - opensearch

  # OpenTelemetry Collector for log collection
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
      - app-logs:/var/log/apps:ro
    networks:
      - skywalking-net
    depends_on:
      - opensearch
      - xiaozhou-order
      - xiaozhou-product

networks:
  skywalking-net:
    driver: bridge

volumes:
  grafana-storage:
  opensearch-data:
  app-logs:
