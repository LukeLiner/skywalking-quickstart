

services:
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: nacos-standalone
    environment:
      - MODE=standalone
    ports:
      - "8848:8848"
      - "9848:9848" # gRPC port for Nacos 2.x
    networks:
      - skywalking-net

  # SkyWalking OAP - NOT receiving agent traces in Full OTel mode
  # Agents report to OTel Collector instead
  skywalking-oap:
    build:
      context: .
      dockerfile: skywalking-oap/Dockerfile
    container_name: skywalking-oap
    ports:
      - "11801:11800"  # Changed to avoid conflict with otel-collector
      - "12801:12800"  # Changed to avoid conflict with otel-collector
    environment:
      - SW_STORAGE=mysql
      - SW_JDBC_URL=jdbc:mysql://mysql:3306/skywalking?useSSL=false&serverTimezone=GMT&allowPublicKeyRetrieval=true
      - SW_DATA_SOURCE_USER=root
      - SW_DATA_SOURCE_PASSWORD=root
    healthcheck:
      test: ["CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/12800"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - skywalking-net
    depends_on:
      mysql:
        condition: service_healthy

  skywalking-ui:
    image: apache/skywalking-ui:9.3.0
    container_name: skywalking-ui
    depends_on:
      skywalking-oap:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      - SW_OAP_ADDRESS=http://skywalking-oap:12800
    networks:
      - skywalking-net

  mysql:
    image: mysql:8.0
    container_name: mysql-db
    environment:
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=mytestshop
    ports:
      - "3306:3306"
    volumes:
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - skywalking-net
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
      timeout: 20s
      retries: 10

  # ============== Kafka Infrastructure ==============
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - skywalking-net
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "2181"]
      interval: 10s
      timeout: 5s
      retries: 5

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s
    networks:
      - skywalking-net

  xiaozhou-order:
    build:
      context: .
      dockerfile: xiaozhou-order/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-order
    ports:
      - "8089:8089"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SW_AGENT_NAME=xiaozhou-order
      # Report to OTel Collector (Full OTel mode - no SkyWalking OAP)
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=otel-collector:11800
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      nacos:
        condition: service_started
    networks:
      - skywalking-net

  xiaozhou-product:
    build:
      context: .
      dockerfile: xiaozhou-product/Dockerfile
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
    container_name: xiaozhou-product
    ports:
      - "8090:8090"
    environment:
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/mytestshop?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2b8&allowMultiQueries=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=root
      - SW_AGENT_NAME=xiaozhou-product
      # Report to OTel Collector (Full OTel mode - no SkyWalking OAP)
      - SW_AGENT_COLLECTOR_BACKEND_SERVICES=otel-collector:11800
    volumes:
      - app-logs:/var/log/apps
      - ${USERPROFILE}/.m2:/root/.m2
    depends_on:
      mysql:
        condition: service_healthy
      nacos:
        condition: service_started
    networks:
      - skywalking-net

  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    networks:
      - skywalking-net
    depends_on:
      - xiaozhou-order
      - xiaozhou-product

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8081:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - skywalking-net

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_SECURITY_ADMIN_USER=admin
    volumes:
      - grafana-storage:/var/lib/grafana
    networks:
      - skywalking-net
    depends_on:
      - prometheus

  # OpenSearch for log storage
  opensearch:
    image: opensearchproject/opensearch:2.11.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
      - DISABLE_SECURITY_PLUGIN=true
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    networks:
      - skywalking-net

  # OpenSearch Dashboards for visualization
  opensearch-dashboards:
    image: opensearchproject/opensearch-dashboards:2.11.0
    container_name: opensearch-dashboards
    ports:
      - "5601:5601"
    environment:
      - OPENSEARCH_HOSTS=http://opensearch:9200
      - DISABLE_SECURITY_DASHBOARDS_PLUGIN=true
      - SERVER_DEFAULTROUTE=/app/home
      - OPENSEARCH_DASHBOARDS_DEFAULTAPPID=home
    networks:
      - skywalking-net
    depends_on:
      - opensearch

  # OpenTelemetry Collector for logs, metrics, and traces
  otel-collector:
    image: otel/opentelemetry-collector-contrib:latest
    container_name: otel-collector
    command: ["--config=/etc/otel-collector-config.yaml"]
    ports:
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
      - "11800:11800"  # SkyWalking gRPC receiver (agents report here)
      - "12800:12800"  # SkyWalking HTTP receiver
      - "8889:8889"    # Prometheus metrics endpoint
    volumes:
      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
      - app-logs:/var/log/apps:ro
    networks:
      - skywalking-net
    depends_on:
      - opensearch
      - data-prepper
      - xiaozhou-order
      - xiaozhou-product

  # Data Prepper for metrics and traces ingestion to OpenSearch
  data-prepper:
    image: opensearchproject/data-prepper:2.6.1
    container_name: data-prepper
    volumes:
      - ./data-prepper/pipelines.yaml:/usr/share/data-prepper/pipelines/pipelines.yaml
      - ./data-prepper/data-prepper-config.yaml:/usr/share/data-prepper/config/data-prepper-config.yaml
    ports:
      - "21890:21890"  # OTel trace source
      - "21891:21891"  # OTel metrics source
    networks:
      - skywalking-net
    depends_on:
      opensearch:
        condition: service_started
      kafka:
        condition: service_healthy
    restart: always

networks:
  skywalking-net:
    driver: bridge

volumes:
  grafana-storage:
  opensearch-data:
  app-logs:
