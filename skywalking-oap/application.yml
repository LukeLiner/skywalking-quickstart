# SkyWalking OAP Server Application Configuration
# This file overrides default application.yml for exporter support

cluster:
  selector: ${SW_CLUSTER:standalone}
  standalone:

core:
  selector: ${SW_CORE:default}
  default:
    role: ${SW_CORE_ROLE:Mixed}
    restHost: ${SW_CORE_REST_HOST:0.0.0.0}
    restPort: ${SW_CORE_REST_PORT:12800}
    restContextPath: ${SW_CORE_REST_CONTEXT_PATH:/}
    gRPCHost: ${SW_CORE_GRPC_HOST:0.0.0.0}
    gRPCPort: ${SW_CORE_GRPC_PORT:11800}
    maxConcurrentCallsPerConnection: ${SW_CORE_GRPC_MAX_CONCURRENT_CALL:0}
    maxMessageSize: ${SW_CORE_GRPC_MAX_MESSAGE_SIZE:0}
    # Records TTL
    recordDataTTL: ${SW_CORE_RECORD_DATA_TTL:3}
    # Metrics TTL
    metricsDataTTL: ${SW_CORE_METRICS_DATA_TTL:7}
    # Enable endpoint name grouping
    enableEndpointNameGroupingByOpenapi: ${SW_CORE_ENABLE_ENDPOINT_NAME_GROUPING_BY_OPENAPI:true}
    # Disable AI pipeline
    enableAIPipeline: ${SW_CORE_ENABLE_AI_PIPELINE:false}

storage:
  selector: ${SW_STORAGE:elasticsearch}
  elasticsearch:
    # Use OpenSearch as storage backend
    clusterNodes: ${SW_STORAGE_ES_CLUSTER_NODES:opensearch:9200}
    # When DISABLE_SECURITY_PLUGIN=true, no auth required
    # user: admin
    # password: admin
    protocol: ${SW_STORAGE_ES_HTTP_PROTOCOL:"http"}
    namespace: ${SW_NAMESPACE:"my_skywalking"}
    indexShardsNumber: ${SW_STORAGE_ES_INDEX_SHARDS:2}
    indexReplicasNumber: ${SW_STORAGE_ES_INDEX_REPLICAS:0}  # For single-node cluster
    bulkActions: ${SW_STORAGE_ES_BULK_ACTIONS:5000}
    flushInterval: ${SW_STORAGE_ES_FLUSH_INTERVAL:10}
    concurrentRequests: ${SW_STORAGE_ES_CONCURRENT_REQUESTS:2}
    resultWindowMaxSize: ${SW_STORAGE_ES_RESULT_WINDOW_MAX_SIZE:10000}
    metadataQueryMaxSize: ${SW_STORAGE_ES_METADATA_QUERY_MAX_SIZE:10000}
    segmentQueryMaxSize: ${SW_STORAGE_ES_SEGMENT_QUERY_MAX_SIZE:200}
    profileTaskQueryMaxSize: ${SW_STORAGE_ES_PROFILE_TASK_QUERY_MAX_SIZE:200}
    putMappingTimeout: ${SW_STORAGE_ES_PUT_MAPPING_TIMEOUT:30}
    createIndexTimeout: ${SW_STORAGE_ES_CREATE_INDEX_TIMEOUT:30}
    queryMaxSize: ${SW_STORAGE_ES_QUERY_MAX_SIZE:10000}
  mysql:
    properties:
      jdbcUrl: ${SW_JDBC_URL:jdbc:mysql://mysql:3306/skywalking?useSSL=false&serverTimezone=GMT&allowPublicKeyRetrieval=true}
      dataSource.user: ${SW_DATA_SOURCE_USER:root}
      dataSource.password: ${SW_DATA_SOURCE_PASSWORD:root}
      dataSource.cachePrepStmts: ${SW_DATA_SOURCE_CACHE_PREP_STMTS:true}
      dataSource.prepStmtCacheSize: ${SW_DATA_SOURCE_PREP_STMT_CACHE_SIZE:250}
      dataSource.prepStmtCacheSqlLimit: ${SW_DATA_SOURCE_PREP_STMT_CACHE_SQL_LIMIT:2048}
      dataSource.useServerPrepStmts: ${SW_DATA_SOURCE_USE_SERVER_PREP_STMTS:true}
    metadataQueryMaxSize: ${SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:2000}
    maxSizeOfBatchSql: ${SW_STORAGE_MAX_SIZE_OF_BATCH_SQL:2000}
    asyncBatchPersistentPoolSize: ${SW_STORAGE_ASYNC_BATCH_PERSISTENT_POOL_SIZE:4}

# ============== KAFKA FETCHER MODULE ==============
# Receive trace/metrics data from Kafka (agents report to Kafka)
kafka-fetcher:
  selector: ${SW_KAFKA_FETCHER:default}
  default:
    bootstrapServers: kafka:9092
    namespace: ${SW_NAMESPACE:""}
    # Consumer group
    groupId: ${SW_KAFKA_FETCHER_GROUP_ID:skywalking-oap}
    # Topic replication factor (set to 1 for single broker)
    replicationFactor: ${SW_KAFKA_FETCHER_REPLICATION_FACTOR:1}
    partitions: ${SW_KAFKA_FETCHER_PARTITIONS:3}
    # Enable partition assignment 
    consumePartitions: ${SW_KAFKA_FETCHER_CONSUME_PARTITIONS:""}
    # Topics for different data types
    topicNameOfTracingSegments: ${SW_KAFKA_FETCHER_TOPIC_TRACING:sw-traces}
    topicNameOfMetrics: ${SW_KAFKA_FETCHER_TOPIC_METRICS:sw-metrics}
    topicNameOfProfiling: ${SW_KAFKA_FETCHER_TOPIC_PROFILING:skywalking-profilings}
    topicNameOfManagement: ${SW_KAFKA_FETCHER_TOPIC_MANAGEMENT:skywalking-managements}
    topicNameOfMeters: ${SW_KAFKA_FETCHER_TOPIC_METERS:skywalking-meters}
    topicNameOfLogs: ${SW_KAFKA_FETCHER_TOPIC_LOGS:skywalking-logs}
    # Enable native log format
    enableNativeProtoLog: ${SW_KAFKA_FETCHER_ENABLE_NATIVE_PROTO_LOG:true}
    enableNativeJsonLog: ${SW_KAFKA_FETCHER_ENABLE_NATIVE_JSON_LOG:false}
    # Consumer config
    kafkaConsumerConfig:
      auto.offset.reset: ${SW_KAFKA_CONSUMER_AUTO_OFFSET_RESET:latest}
      enable.auto.commit: ${SW_KAFKA_CONSUMER_ENABLE_AUTO_COMMIT:true}

# ============== AGENT ANALYZER MODULE ==============
agent-analyzer:
  selector: ${SW_AGENT_ANALYZER:default}
  default:
    traceSamplingPolicySettingsFile: ${SW_TRACE_SAMPLING_POLICY_SETTINGS_FILE:trace-sampling-policy-settings.yml}
    slowDBAccessThreshold: ${SW_SLOW_DB_THRESHOLD:default:200,mongodb:100}
    forceSampleErrorSegment: ${SW_FORCE_SAMPLE_ERROR_SEGMENT:true}
    segmentStatusAnalysisStrategy: ${SW_SEGMENT_STATUS_ANALYSIS_STRATEGY:FROM_SPAN_STATUS}
    noUpstreamRealAddressAgents: ${SW_NO_UPSTREAM_REAL_ADDRESS:6000,9000}
    meterAnalyzerActiveFiles: ${SW_METER_ANALYZER_ACTIVE_FILES:spring-sleuth.yaml,datasource.yaml}

receiver-sharing-server:
  selector: ${SW_RECEIVER_SHARING_SERVER:default}
  default:

receiver-register:
  selector: ${SW_RECEIVER_REGISTER:default}
  default:

receiver-trace:
  selector: ${SW_RECEIVER_TRACE:default}
  default:

receiver-jvm:
  selector: ${SW_RECEIVER_JVM:default}
  default:

receiver-clr:
  selector: ${SW_RECEIVER_CLR:default}
  default:

receiver-profile:
  selector: ${SW_RECEIVER_PROFILE:default}
  default:

receiver-meter:
  selector: ${SW_RECEIVER_METER:default}
  default:

receiver-log:
  selector: ${SW_RECEIVER_LOG:default}
  default:

receiver-browser:
  selector: ${SW_RECEIVER_BROWSER:default}
  default:

service-mesh:
  selector: ${SW_SERVICE_MESH:default}
  default:

envoy-metric:
  selector: ${SW_ENVOY_METRIC:default}
  default:

query:
  selector: ${SW_QUERY:graphql}
  graphql:

alarm:
  selector: ${SW_ALARM:default}
  default:

telemetry:
  selector: ${SW_TELEMETRY:prometheus}
  prometheus:
    host: ${SW_TELEMETRY_PROMETHEUS_HOST:0.0.0.0}
    port: ${SW_TELEMETRY_PROMETHEUS_PORT:1234}

configuration:
  selector: ${SW_CONFIGURATION:none}
  none:

health-checker:
  selector: ${SW_HEALTH_CHECKER:default}
  default:

configuration-discovery:
  selector: ${SW_CONFIGURATION_DISCOVERY:default}
  default:

event-analyzer:
  selector: ${SW_EVENT_ANALYZER:default}
  default:

receiver-event:
  selector: ${SW_RECEIVER_EVENT:default}
  default:

log-analyzer:
  selector: ${SW_LOG_ANALYZER:default}
  default:
    lalFiles: ${SW_LOG_LAL_FILES:default}
    malFiles: ${SW_LOG_MAL_FILES:""}

